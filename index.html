<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="assets/favicon.ico">
  <title>Raw Copy App</title>

  <!-- =============================================================
       [1] STYLES & THEME
     ============================================================= -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#f5f3ff',
              100: '#ede9fe',
              200: '#ddd6fe',
              300: '#c4b5fd',
              400: '#a78bfa',
              500: '#8b5cf6',
              600: '#7c3aed',
              700: '#6d28d9',
              800: '#5b21b6',
              900: '#4c1d95'
            }
          },
          fontFamily: { inter: ['Inter', 'ui-sans-serif', 'system-ui'] },
          backgroundImage: {
            'brand-gradient':
              'radial-gradient(1200px 800px at 10% 0%, rgba(124,58,237,.18), transparent 40%), radial-gradient(1000px 700px at 90% 0%, rgba(91,33,182,.18), transparent 45%), linear-gradient(180deg, rgba(139,92,246,.06), rgba(17,24,39,.06))'
          },
          boxShadow: { soft: '0 6px 30px -10px rgba(124,58,237,.25)' }
        }
      }
    }
  </script>

  <!-- Icons (Font Awesome) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    html, body { height: 100%; }
  </style>
</head>
<body class="min-h-screen font-inter text-gray-800 dark:text-gray-100 bg-brand-gradient bg-fixed dark:bg-[#0b0b12]">
  
  <!-- =============================================================
       [2] DECORATION
     ============================================================= -->
  <div class="pointer-events-none fixed inset-0 -z-10 opacity-70 dark:opacity-80"
       style="background: radial-gradient(600px 300px at 20% -5%, rgba(139,92,246,.22), transparent), radial-gradient(700px 320px at 80% -5%, rgba(109,40,217,.22), transparent);"></div>

  <!-- =============================================================
       [3] HEADER
     ============================================================= -->
  <header class="sticky top-0 z-30 backdrop-blur bg-white/75 dark:bg-[#0b0b12]/70 border-b border-white/40 dark:border-white/10">
    <div class="max-w-6xl mx-auto px-4 md:px-6 py-3 flex items-center justify-between">
      <a class="flex items-center gap-3 select-none" href="#" aria-label="Beranda">
        <!-- Logo -->
        <div class="relative h-10 w-10 shrink-0" aria-hidden="true">
          <div class="absolute inset-0 rounded-2xl bg-gradient-to-br from-brand-500 via-brand-600 to-brand-800 shadow-lg shadow-brand-900/30"></div>
          <svg viewBox="0 0 24 24" class="absolute inset-0 m-auto h-5 w-5 text-white" aria-hidden="true">
            <path fill="currentColor" d="M4 7a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v1h3a2 2 0 0 1 2 2v7a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7Zm10 1V7a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-7h-3a1 1 0 0 1-1-1Zm-6.5 5.5h9a.75.75 0 0 1 0 1.5h-9a.75.75 0 0 1 0-1.5Zm0-3h5a.75.75 0 0 1 0 1.5h-5a.75.75 0 0 1 0-1.5Z"/>
          </svg>
        </div>
        <div class="min-w-0">
          <h1 class="text-base md:text-lg font-semibold leading-tight truncate">Raw Copy App</h1>
          <p class="text-xs text-gray-600 dark:text-gray-400 truncate">Pilih. Salin atau Pindah. Selesai.</p>
        </div>
      </a>

      <!-- Theme Toggle + Help -->
      <div class="flex items-center gap-2">
        <button id="darkToggle" class="group inline-flex items-center gap-2 rounded-xl border border-gray-300/70 dark:border-white/10 px-3 py-1.5 text-sm transition duration-200 hover:bg-brand-50 hover:border-brand-300 dark:hover:bg-white/5" aria-label="Ubah tema">
          <span id="themeLabel">Gelap</span>
          <!-- Icon -->
          <i id="iconSun" class="fa-solid fa-sun hidden" aria-hidden="true"></i>
          <i id="iconMoon" class="fa-solid fa-moon" aria-hidden="true"></i>
        </button>
        <!-- <a href="#notes" class="hidden sm:inline text-sm text-brand-700 dark:text-brand-300 hover:underline">Bantuan</a> -->
      </div>
    </div>
  </header>

  <!-- =============================================================
       [4] MAIN
     ============================================================= -->
  <main class="max-w-6xl mx-auto px-4 md:px-6 py-6 md:py-10 grid gap-6 md:gap-8">

    <!-- Intro Tagline -->
    <section class="rounded-3xl border border-white/40 dark:border-white/10 bg-white/80 dark:bg-[#12121b]/80 backdrop-blur p-4 md:p-6 shadow-sm">
      <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div class="max-w-3xl">
          <h2 class="text-lg md:text-xl font-semibold">Temukan. Salin. Pindah. Selesai.</h2>
          <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Masukkan daftar nomor file atau 4 digit terakhir, alat ini akan menemukan, menyalin, atau memindahkannya untukmu. Cocok untuk <span class="font-medium">wedding</span>, <span class="font-medium">wisuda</span>, dan event besar.</p>
        </div>
      </div>
    </section>

    <!-- Folder Pickers (Source & Destination) -->
    <section class="grid gap-4 md:grid-cols-2">
      <!-- Source -->
      <div class="rounded-2xl border border-white/40 dark:border-white/10 bg-white/80 dark:bg-[#12121b]/80 backdrop-blur p-4 md:p-5 shadow-sm">
        <h3 class="text-base font-semibold mb-3">1) Folder Sumber</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Pilih folder berisi file RAW. Aktifkan <em>rekursif</em> bila ada subfolder.</p>
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
          <button id="btnPickSource" class="w-full sm:w-auto inline-flex items-center gap-2 group rounded-xl bg-brand-700 text-white px-4 py-2 text-sm font-medium transition duration-200 hover:bg-brand-600 hover:shadow-lg hover:shadow-brand-900/20 active:scale-[.98]">
            <i class="fa-solid fa-folder-open transition-transform duration-200 group-hover:scale-110" aria-hidden="true"></i>
            <span>Pilih Folder Sumber</span>
          </button>
          <label class="flex items-center gap-2 text-sm">
            <input id="chkRecursive" type="checkbox" class="h-4 w-4 rounded border-gray-300 dark:border-white/10">
            Rekursif (scan subfolder)
          </label>
        </div>
        <p id="lblSource" class="mt-3 text-sm text-gray-700 dark:text-gray-300 line-clamp-2" aria-live="polite"></p>
      </div>

      <!-- Destination -->
      <div class="rounded-2xl border border-white/40 dark:border-white/10 bg-white/80 dark:bg-[#12121b]/80 backdrop-blur p-4 md:p-5 shadow-sm">
        <h3 class="text-base font-semibold mb-3">2) Folder Tujuan</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Pilih folder tempat menyimpan hasil salin/pindah.</p>
        <button id="btnPickDest" class="w-full sm:w-auto inline-flex items-center gap-2 group rounded-xl bg-brand-600 text-white px-4 py-2 text-sm font-medium transition duration-200 hover:bg-brand-500 hover:shadow-lg hover:shadow-brand-900/20 active:scale-[.98]">
          <i class="fa-solid fa-folder-plus transition-transform duration-200 group-hover:scale-110" aria-hidden="true"></i>
          <span>Pilih Folder Tujuan</span>
        </button>
        <p id="lblDest" class="mt-3 text-sm text-gray-700 dark:text-gray-300 line-clamp-2" aria-live="polite"></p>
      </div>
    </section>

    <!-- Filters & File List -->
    <section class="rounded-2xl border border-white/40 dark:border-white/10 bg-white/80 dark:bg-[#12121b]/80 backdrop-blur p-4 md:p-5 shadow-sm">
      <h3 class="text-base font-semibold mb-3">3) Filter & Daftar File</h3>

      <div class="grid gap-4">
        <!-- Extension Dropdown (Custom) -->
        <div class="grid gap-2">
          <label for="extTrigger" class="text-sm font-medium">Ekstensi RAW</label>

          <div id="extDropdown" class="relative">
            <!-- Trigger -->
            <button id="extTrigger"
              class="w-full inline-flex items-center justify-between gap-3 rounded-xl border border-gray-300/80 dark:border-white/10 bg-white/80 dark:bg-[#161622]/90 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-400/60 transition-colors duration-150"
              aria-haspopup="listbox" aria-expanded="false">
              <span id="extTriggerLabel" class="truncate">Pilih Format Ekstensi</span>
              <i class="fa-solid fa-chevron-down text-xs opacity-70" aria-hidden="true"></i>
            </button>

            <!-- Menu -->
            <div id="extMenu"
              class="hidden absolute z-20 mt-2 w-full rounded-xl border border-white/40 dark:border-white/10 bg-white/95 dark:bg-[#0f0f17]/95 shadow-soft backdrop-blur p-1 max-h-64 overflow-auto"
              role="listbox" aria-label="Pilih ekstensi RAW">
              <button data-value=".CR2" class="dd-item" role="option">Canon (.CR2)</button>
              <button data-value=".CR3" class="dd-item" role="option">Canon (.CR3)</button>
              <button data-value=".ARW" class="dd-item" role="option">Sony (.ARW)</button>
              <button data-value=".NEF" class="dd-item" role="option">Nikon (.NEF)</button>
              <button data-value=".RAF" class="dd-item" role="option">Fujifilm (.RAF)</button>
              <button data-value=".RW2" class="dd-item" role="option">Panasonic (.RW2)</button>
              <button data-value=".ORF" class="dd-item" role="option">Olympus (.ORF)</button>
              <button data-value=".PEF" class="dd-item" role="option">Pentax (.PEF)</button>
              <button data-value=".DNG" class="dd-item" role="option">DNG (.DNG)</button>
              <button data-value="*" class="dd-item" role="option">Semua RAW umum</button>
              <button data-value="custom" class="dd-item" role="option">Custom…</button>
            </div>
          </div>

          <!-- Custom Extension Input -->
          <input id="extCustom" type="text" placeholder="Mis. .SR2"
                 class="hidden rounded-xl border border-gray-300/80 dark:border-white/10 bg-white/80 dark:bg-[#161622]/90 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-400/60" />
        </div>

        <!-- Textarea -->
        <div class="grid gap-2">
          <label for="nameList" class="text-sm font-medium">Masukkan Nama / 4 Digit Terakhir</label>
          <textarea id="nameList" rows="6"
            placeholder="Contoh: 1. 2153, IMG_4521, DSC0217"
            class="rounded-2xl border border-gray-300/80 dark:border-white/10 bg-white/80 dark:bg-[#161622]/90 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-400/60"></textarea>
          <p class="text-xs text-gray-600 dark:text-gray-400">Satu entri per baris. Boleh <span class="font-medium">nama file tanpa ekstensi</span> atau hanya <span class="font-medium">3–4 digit terakhir</span>. Nomor urut otomatis diabaikan.</p>
        </div>
      </div>
    </section>

    <!-- Actions & Progress -->
    <section class="rounded-2xl border border-white/40 dark:border-white/10 bg-white/80 dark:bg-[#12121b]/80 backdrop-blur p-4 md:p-5 shadow-sm">
      <h3 class="text-base font-semibold mb-3">4) Eksekusi</h3>
      <div class="flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-3">
        <button id="btnCopy" class="w-full sm:w-auto inline-flex items-center gap-2 group rounded-xl bg-brand-600 text-white px-4 py-2 text-sm font-semibold transition duration-200 hover:bg-brand-500 hover:shadow-lg hover:shadow-brand-900/20 active:scale-[.98]">
          <i class="fa-solid fa-copy transition-transform duration-200 group-hover:scale-110" aria-hidden="true"></i>
          <span>Mulai Salin</span>
        </button>
        <button id="btnMove" class="w-full sm:w-auto inline-flex items-center gap-2 group rounded-xl bg-brand-700 text-white px-4 py-2 text-sm font-semibold transition duration-200 hover:bg-brand-600 hover:shadow-lg hover:shadow-brand-900/20 active:scale-[.98]">
          <i class="fa-solid fa-right-left transition-transform duration-200 group-hover:scale-110" aria-hidden="true"></i>
          <span>Mulai Pindah</span>
        </button>
        <button id="btnClear" class="w-full sm:w-auto rounded-xl border border-brand-300/60 text-brand-800 dark:text-brand-200 px-4 py-2 text-sm transition duration-200 hover:bg-brand-50/70 dark:hover:bg-white/5">
          Bersihkan
        </button>
        <span id="statusText" class="text-sm text-gray-700 dark:text-gray-300" aria-live="polite"></span>
      </div>
      <div class="mt-4">
        <div class="w-full h-2 bg-brand-100/70 dark:bg-white/10 rounded-full overflow-hidden">
          <div id="progressBar" class="h-2 bg-brand-600 w-0 transition-[width] duration-300"></div>
        </div>
        <p id="progressLabel" class="text-xs text-gray-700 dark:text-gray-300 mt-1">0/0</p>
      </div>
    </section>

    <!-- Results Lists -->
    <section class="rounded-2xl border border-white/40 dark:border-white/10 bg-white/80 dark:bg-[#12121b]/80 backdrop-blur p-4 md:p-5 shadow-sm">
      <h3 class="text-base font-semibold mb-3">Hasil</h3>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <h4 class="text-sm font-semibold mb-2">Berhasil ✅</h4>
          <ul id="okList" class="text-sm grid gap-1 list-disc pl-5"></ul>
        </div>
        <div>
          <h4 class="text-sm font-semibold mb-2">Gagal ❌</h4>
          <ul id="failList" class="text-sm grid gap-1 list-disc pl-5"></ul>
        </div>
      </div>
    </section>

    
    <!-- Notes -->
    <section id="notes" class="rounded-2xl border border-white/40 dark:border-white/10 bg-white/80 dark:bg-[#12121b]/80 backdrop-blur p-4 md:p-5 shadow-sm">
      <h3 class="text-base font-semibold mb-2">Catatan</h3>
      <ul class="text-sm text-gray-600 dark:text-gray-400 list-disc pl-5 grid gap-2">
        <li>Aplikasi menggunakan <span class="font-medium">File System Access API</span>. Saat diminta, pilih folder sumber dan tujuan. Seluruh proses berjalan <span class="font-medium">lokal di perangkat</span>.</li>
        <li>Opsi <span class="font-medium">Rekursif</span> akan menyertakan seluruh subfolder saat pemindaian.</li>
        <li><span class="font-medium">Format RAW yang didukung:</span> .ARW, .CR2, .CR3, .NEF, .RAF, .RW2, .ORF, .PEF, .DNG. Untuk format lain, pilih <span class="font-medium">Custom…</span> lalu masukkan ekstensi (mis. .SR2).</li>
        <li>Masukkan <span class="font-medium">nama file</span> (boleh tanpa ekstensi) atau <span class="font-medium">3–4 digit terakhir</span>. Penomoran di awal baris (1. 2153), <span class="font-mediuim">akan diabaikan otomatis</span>.</li>
        <li> <span class="font-medium">Pindah</span> akan menyalin file terlebih dulu, lalu menghapusnya dari folder sumber setelah berhasil. Fitur ini memerlukan <span class="font-medium">izin tulis</span> pada folder sumber.</li>
      </ul>
    </section>
  </main>

  <!-- =============================================================
       [5] TOAST
     ============================================================= -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 hidden" aria-live="polite">
    <div class="rounded-2xl bg-gray-900 text-white dark:bg-white dark:text-gray-900 shadow-lg px-4 py-3 text-sm"></div>
  </div>

  <!-- =============================================================
       [6] FOOTER
     ============================================================= -->
  <footer class="mt-10 border-t border-white/40 dark:border-white/10">
    <div class="max-w-6xl mx-auto px-4 md:px-6 py-6 text-xs text-gray-700 dark:text-gray-300 text-center">
      <p>© <span id="year"></span> <span class="font-medium">Raw Copy Tools</span> · <a href="https://www.instagram.com/rifairmdhnn_/" target="_blank" rel="noopener" class="text-brand-700 dark:text-brand-300 hover:underline">Achmad Rifa'i Ramadhan</a></p>
    </div>
  </footer>

  <script>
    // =============================================================
    // [7] THEME HANDLER
    // =============================================================
    const darkToggle = document.getElementById('darkToggle');
    const themeLabel = document.getElementById('themeLabel');
    const iconSun = document.getElementById('iconSun');
    const iconMoon = document.getElementById('iconMoon');

    function syncThemeUI(isDark){
      // Icon & Label
      themeLabel.textContent = isDark ? 'Gelap' : 'Terang';
      iconMoon.classList.toggle('hidden', !isDark); // dark: moon tampil
      iconSun.classList.toggle('hidden', isDark);   // light: sun tampil
      darkToggle.setAttribute('aria-pressed', String(isDark));
    }

    const root = document.documentElement;
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initDark = savedTheme ? savedTheme === 'dark' : prefersDark;

    // Inisialisasi
    root.classList.add('no-theme-transition');
    root.classList.toggle('dark', initDark);
    syncThemeUI(initDark);
    requestAnimationFrame(()=>{ root.classList.remove('no-theme-transition'); });

    // Klik Toggle
    darkToggle.addEventListener('click', () => {
      root.classList.add('no-theme-transition');
      const isDark = root.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      syncThemeUI(isDark);
      requestAnimationFrame(()=>{ root.classList.remove('no-theme-transition'); });
    });

    // Footer Year
    document.getElementById('year').textContent = new Date().getFullYear();

    // =============================================================
    // [8] DOM HOOKS
    // =============================================================
    const btnPickSource = document.getElementById('btnPickSource');
    const btnPickDest   = document.getElementById('btnPickDest');
    const lblSource     = document.getElementById('lblSource');
    const lblDest       = document.getElementById('lblDest');
    const nameList      = document.getElementById('nameList');
    const btnCopy       = document.getElementById('btnCopy');
    const btnMove       = document.getElementById('btnMove');
    const btnClear      = document.getElementById('btnClear');
    const chkRecursive  = document.getElementById('chkRecursive');

    const okList        = document.getElementById('okList');
    const failList      = document.getElementById('failList');
    const progressBar   = document.getElementById('progressBar');
    const progressLabel = document.getElementById('progressLabel');
    const statusText    = document.getElementById('statusText');

    const toast   = document.getElementById('toast');
    const toastBox= toast.querySelector('div');

    let sourceHandle = null; // FileSystemDirectoryHandle (Source)
    let destHandle   = null; // FileSystemDirectoryHandle (Destination)

    // =============================================================
    // [9] TOAST UTIL
    // =============================================================
    function showToast(msg) {
      toastBox.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 2200);
    }

    // =============================================================
    // [10] EXTENSION DROPDOWN (Custom)
    // =============================================================
    const extDropdown     = document.getElementById('extDropdown');
    const extTrigger      = document.getElementById('extTrigger');
    const extTriggerLabel = document.getElementById('extTriggerLabel');
    const extMenu         = document.getElementById('extMenu');
    const extCustom       = document.getElementById('extCustom');

    let extValue = '.ARW';
    extTrigger.dataset.value = extValue;

    function closeMenu()  { extMenu.classList.add('hidden');  extTrigger.setAttribute('aria-expanded', 'false'); }
    function openMenu()   { extMenu.classList.remove('hidden'); extTrigger.setAttribute('aria-expanded', 'true'); }
    function toggleMenu() { extMenu.classList.toggle('hidden');
      extTrigger.setAttribute('aria-expanded', String(!extMenu.classList.contains('hidden')));
    }

    function setExtValue(val, labelText) {
      extValue = val;
      extTrigger.dataset.value = val;
      extTriggerLabel.textContent = labelText;
      if (val === 'custom') {
        extCustom.classList.remove('hidden');
        extCustom.focus();
      } else {
        extCustom.classList.add('hidden');
      }
      closeMenu();
    }

    extTrigger.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMenu();
    });

    // Item Click
    extMenu.querySelectorAll('.dd-item').forEach(btn => {
      btn.classList.add(
      'w-full','text-left','px-3','py-2','rounded-lg',
      'hover:bg-brand-50/90','dark:hover:bg-white/10','transition-colors','duration-150'
    );
      btn.addEventListener('click', (e) => {
        const val   = e.currentTarget.getAttribute('data-value');
        const label = e.currentTarget.textContent.trim();
        setExtValue(val, label);
      });
    });

    // Close on Outside Click
    document.addEventListener('click', (e) => {
      if (!extDropdown.contains(e.target)) closeMenu();
    });

    // Basic Keys
    extTrigger.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleMenu(); }
      if (e.key === 'Escape') { closeMenu(); }
    });

    // =============================================================
    // [11] FILE SYSTEM ACCESS HELPERS
    // =============================================================
    async function verifyPermission(handle, mode = 'read') {
      const opts = { mode };
      if ((await handle.queryPermission(opts)) === 'granted') return true;
      if ((await handle.requestPermission(opts)) === 'granted') return true;
      return false;
    }

    // Pick Source Directory
    btnPickSource.addEventListener('click', async () => {
      try {
        sourceHandle = await window.showDirectoryPicker();
        const ok = await verifyPermission(sourceHandle, 'read');
        if (!ok) { showToast('Izin baca ditolak'); return; }
        lblSource.textContent = 'Sumber: ' + sourceHandle.name;
        showToast('Folder sumber dipilih');
      } catch (e) {
        if (e.name !== 'AbortError') console.error(e);
      }
    });

    // Pick Destination Directory
    btnPickDest.addEventListener('click', async () => {
      try {
        destHandle = await window.showDirectoryPicker();
        const ok = await verifyPermission(destHandle, 'readwrite');
        if (!ok) { showToast('Izin tulis ditolak'); return; }
        lblDest.textContent = 'Tujuan: ' + destHandle.name;
        showToast('Folder tujuan dipilih');
      } catch (e) {
        if (e.name !== 'AbortError') console.error(e);
      }
    });

    // Iterate Directory
    async function* walkDirWithParent(dirHandle) {
      for await (const [name, handle] of dirHandle.entries()) {
        if (handle.kind === 'file') {
          yield [name, handle, dirHandle];
        } else if (handle.kind === 'directory' && chkRecursive.checked) {
          yield* walkDirWithParent(handle);
        }
      }
    }

    // Selected Extensions Array
    function getSelectedExtensions() {
      const common = ['.ARW','.CR2','.CR3','.NEF','.RAF','.RW2','.ORF','.PEF','.DNG'];
      const val = extValue;
      if (val === '*') return common;
      if (val === 'custom') {
        const c = (extCustom.value || '').trim();
        if (!c) return [];
        return [c.startsWith('.') ? c.toUpperCase() : ('.' + c.toUpperCase())];
      }
      return [val.toUpperCase()];
    }

    // Parse List
    function parseWantedList(raw) {
      const lines = raw.split(/\n|\r/).map(l => l.trim()).filter(Boolean);
      const wanted = [];
      for (const line of lines) {
        const cleaned = line.replace(/^\s*[\-\d]+[\).]*\s*/, '');
        if (!cleaned) continue;
        wanted.push(cleaned);
      }
      return wanted;
    }

    // Split Filename
    function splitName(name) {
      const idx = name.lastIndexOf('.');
      if (idx === -1) return [name, ''];
      return [name.slice(0, idx), name.slice(idx)];
    }

    // Match Strategy
    function matchesToken(fileName, token) {
      const [stem, ext] = splitName(fileName);
      token = token.toLowerCase();
      const fullNoExt = stem.toLowerCase();

      if (fullNoExt === token) return true;
      if ((fullNoExt + ext.toLowerCase()) === token) return true;

      if (/^\d{3,4}$/.test(token)) {
        const digits = (stem.match(/\d+/g) || []).join('');
        if (!digits) return false;
        const last4 = digits.slice(-4);
        const last3 = digits.slice(-3);
        return token === last4 || token === last3;
      }

      if (/\.[a-z0-9]{2,4}$/i.test(token)) {
        return (stem + ext).toLowerCase() === token;
      }

      return fullNoExt.includes(token);
    }

    // Collect Candidate Files
    async function collectSourceFilesByExtWithParent(dirHandle, allowedExts) {
      const items = [];
      for await (const [name, handle, parent] of walkDirWithParent(dirHandle)) {
        const ext = name.slice(name.lastIndexOf('.')).toUpperCase();
        if (allowedExts.includes(ext)) {
          items.push({ name, handle, parent });
        }
      }
      return items;
    }

    // UI: Reset Results & Progress
    function resetResults() {
      okList.innerHTML = '';
      failList.innerHTML = '';
      setProgress(0, 0);
      statusText.textContent = '';
    }

    // UI: Progress Bar
    function setProgress(done, total) {
      const pct = total === 0 ? 0 : Math.round((done / total) * 100);
      progressBar.style.width = pct + '%';
      progressLabel.textContent = `${done}/${total} (${pct}%)`;
    }

    // Preflight Checks: Handles & Permissions
    async function ensureReady() {
      if (!sourceHandle) { showToast('Pilih folder sumber terlebih dahulu'); return false; }
      if (!destHandle)   { showToast('Pilih folder tujuan terlebih dahulu'); return false; }
      const canRead  = await verifyPermission(sourceHandle, 'read');
      if (!canRead)  { showToast('Izin baca sumber ditolak'); return false; }
      const canWrite = await verifyPermission(destHandle, 'readwrite');
      if (!canWrite) { showToast('Izin tulis tujuan ditolak'); return false; }
      return true;
    }

    // Main Pipeline: Copy or Move
    async function copyOrMove(action) {
      if (!(await ensureReady())) return;
      resetResults();

      const allowedExts = getSelectedExtensions();
      if (allowedExts.length === 0) { showToast('Masukkan ekstensi custom'); return; }

      const tokens = parseWantedList(nameList.value);
      if (tokens.length === 0) { showToast('Daftar nama/4 digit masih kosong'); return; }

      statusText.textContent = 'Memindai folder sumber…';
      const items = await collectSourceFilesByExtWithParent(sourceHandle, allowedExts);
      const candidates = items.filter(it => tokens.some(t => matchesToken(it.name, t)));

      if (candidates.length === 0) {
        statusText.textContent = 'Tidak ada file yang cocok.';
        showToast('Tidak ditemukan file cocok');
        return;
      }

      statusText.textContent = `${candidates.length} file ditemukan. Memulai…`;
      let done = 0;
      setProgress(0, candidates.length);

      for (const item of candidates) {
        try {
          // Copy to Destination
          const file = await item.handle.getFile();
          const destFileHandle = await destHandle.getFileHandle(item.name, { create: true });
          const writable = await destFileHandle.createWritable();
          await writable.write(await file.arrayBuffer());
          await writable.close();

          // If Move
          if (action === 'move') {
            const ok = await verifyPermission(item.parent, 'readwrite');
            if (ok) await item.parent.removeEntry(item.name);
          }

          // Success Log
          const li = document.createElement('li');
          li.textContent = item.name;
          okList.appendChild(li);
        } catch (err) {
          // Failure Log
          console.error(err);
          const li = document.createElement('li');
          li.textContent = item.name + ' — ' + (err?.message || 'gagal');
          failList.appendChild(li);
        } finally {
          done += 1;
          setProgress(done, candidates.length);
        }
      }

      const allOk = failList.children.length === 0;
      statusText.textContent = allOk ? 'Selesai tanpa error.' : 'Selesai dengan beberapa error.';
      alert(allOk ? 'Semua file berhasil diproses.' : 'Selesai. Beberapa file gagal. Cek daftar hasil.');
    }

    // Bind Actions
    btnCopy.addEventListener('click', () => copyOrMove('copy'));
    btnMove.addEventListener('click', () => copyOrMove('move'));
    btnClear.addEventListener('click', () => {
      nameList.value = '';
      resetResults();
      showToast('Form dibersihkan');
    });
  </script>

  <style>
    /* =============================================================
       [A] DROPDOWN SCROLLBAR
     ============================================================= */
    #extMenu::-webkit-scrollbar { width: 10px; }
    #extMenu::-webkit-scrollbar-thumb { background: rgba(167,139,250,.6); border-radius: 999px; }
    #extMenu::-webkit-scrollbar-track { background: transparent; }

    /* [B] Dropdown Items */
    .dd-item { display:block; width:100%; text-align:left; padding:.5rem .75rem; border-radius:.5rem; }
    .dd-item:hover { background: rgba(167,139,250,.1); }
    .dark .dd-item:hover { background: rgba(255,255,255,.08); }
  </style>
  <style>
    /* [C] Disable Transitions */
    .no-theme-transition *, .no-theme-transition *::before, .no-theme-transition *::after {
      transition-property: none !important;
      transition-duration: 0ms !important;
    }
  </style>
</body>
</html>
